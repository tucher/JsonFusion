name: Benchmarks

on:
  # Manual trigger
  workflow_dispatch:
  # Optional: run on pushes to main / tags
  push:
    branches: [ main ]
    paths:
      - 'include/**'
      - 'benchmarks/**'
      - 'CMakeLists.txt'
      - '.github/workflows/benchmarks.yml'

jobs:
  run-benchmarks:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y cmake ninja-build

      - name: Run benchmarks
        run: |
          mkdir -p ci_out
          # capture both stdout and stderr
          scripts/run_benchmarks.sh 2>&1 | tee ci_out/benchmarks.log

      - name: Attach benchmark log to job summary
        run: |
          {
            echo '## JsonFusion Benchmarks'
            echo
            echo 'Last run:'
            echo
            echo '```'
            sed -n '1,200p' ci_out/benchmarks.log
            echo '```'
          } >> "$GITHUB_STEP_SUMMARY"

      - name: Upload full benchmark log as artifact
        uses: actions/upload-artifact@v4
        with:
          name: benchmark-log
          path: ci_out/benchmarks.log
